<template>
  <div class="space-y-5">
    <!-- í•„ìˆ˜ í•­ëª© ì•ˆë‚´ -->
    <div class="required-notice">
      <div class="notice-icon">âš ï¸</div>
      <div class="notice-text">
        <strong>í•„ìˆ˜ ì…ë ¥ í•­ëª©</strong>ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”
        <div class="notice-items">í‚¤, ëª¸ë¬´ê²Œ, ìš´ë™ ëª©í‘œ</div>
      </div>
    </div>
    <!-- ì‹ ì²´ ì •ë³´ ì„¹ì…˜ -->
    <div class="section-header">
      <h3 class="section-title">
        <span class="section-icon">ğŸ“Š</span>
        ì‹ ì²´ ì •ë³´
      </h3>
      <p class="section-subtitle">ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‹ ì²´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    </div>

    <!-- í‚¤ & ëª¸ë¬´ê²Œ -->
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label required">
          <span class="label-icon">ğŸ“</span>
          í‚¤ (cm)
        </label>
        <input 
          v-model.number="model.height" 
          type="number" 
          class="form-input"
          :class="{ 'error': errors.height }"
          placeholder="170"
          min="100"
          max="250"
        />
        <p v-if="errors.height" class="error-message">í‚¤ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.</p>
      </div>

      <div class="form-group">
        <label class="form-label required">
          <span class="label-icon">âš–ï¸</span>
          ëª¸ë¬´ê²Œ (kg)
        </label>
        <input 
          v-model.number="model.weight" 
          type="number" 
          class="form-input"
          :class="{ 'error': errors.weight }"
          placeholder="70"
          min="30"
          max="200"
        />
        <p v-if="errors.weight" class="error-message">ëª¸ë¬´ê²ŒëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.</p>
      </div>
    </div>

    <!-- ì²´ì„±ë¶„ ì •ë³´ -->
    <div class="section-divider">
      <h4 class="subsection-title">
        <span class="subsection-icon">ğŸ”¬</span>
        ì²´ì„±ë¶„ ì •ë³´ (ì„ íƒì‚¬í•­)
      </h4>
    </div>

    <!-- ì²´ìˆ˜ë¶„ & ë‹¨ë°±ì§ˆëŸ‰ -->
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ’§</span>
          ì²´ìˆ˜ë¶„ (%)
        </label>
        <input 
          v-model.number="model.bodyWater" 
          type="number" 
          class="form-input"
          placeholder="60"
          min="0"
          max="100"
          step="0.1"
        />
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ¥©</span>
          ë‹¨ë°±ì§ˆëŸ‰ (%)
        </label>
        <input 
          v-model.number="model.protein" 
          type="number" 
          class="form-input"
          placeholder="20"
          min="0"
          max="100"
          step="0.1"
        />
      </div>
    </div>

    <!-- ë¬´ê¸°ì§ˆ & ì²´ì§€ë°© -->
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">âš™ï¸</span>
          ë¬´ê¸°ì§ˆ (%)
        </label>
        <input 
          v-model.number="model.mineral" 
          type="number" 
          class="form-input"
          placeholder="5"
          min="0"
          max="100"
          step="0.1"
        />
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ”¥</span>
          ì²´ì§€ë°© (kg)
        </label>
        <input 
          v-model.number="model.bodyFat" 
          type="number" 
          class="form-input"
          placeholder="15"
          min="0"
          max="100"
          step="0.1"
        />
      </div>
    </div>

    <!-- ê³¨ê²©ê·¼ëŸ‰ & ì²´ì§€ë°©ëŸ‰ -->
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ’ª</span>
          ê³¨ê²©ê·¼ëŸ‰ (kg)
        </label>
        <input 
          v-model.number="model.skeletalMuscle" 
          type="number" 
          class="form-input"
          placeholder="30"
          min="0"
          max="100"
          step="0.1"
        />
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ§ˆ</span>
          ì²´ì§€ë°©ëŸ‰ (kg)
        </label>
        <input 
          v-model.number="model.bodyFatMass" 
          type="number" 
          class="form-input"
          placeholder="12"
          min="0"
          max="100"
          step="0.1"
        />
      </div>
    </div>

    <!-- BMI & ì²´ì§€ë°©ë¥  -->
    <div class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ“Š</span>
          BMI
        </label>
        <input 
          v-model.number="model.bmi" 
          type="number" 
          class="form-input"
          placeholder="22.5"
          min="10"
          max="50"
          step="0.1"
        />
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-icon">ğŸ“‰</span>
          ì²´ì§€ë°©ë¥  (%)
        </label>
        <input 
          v-model.number="model.bodyFatPercentage" 
          type="number" 
          class="form-input"
          placeholder="18"
          min="0"
          max="100"
          step="0.1"
        />
      </div>
    </div>

    <!-- ëª©í‘œ ì„¹ì…˜ -->
    <div class="section-divider">
      <h4 class="subsection-title">
        <span class="subsection-icon">ğŸ¯</span>
        ëª©í‘œ ì„¤ì •
      </h4>
    </div>

    <!-- ëª©í‘œ ì„ íƒ -->
    <div class="form-group">
      <label class="form-label required">
        <span class="label-icon">ğŸ¯</span>
        ìš´ë™ ëª©í‘œ
      </label>
      <select v-model="model.goal" class="form-input" :class="{ 'error': errors.goal }">
        <option disabled value="">ëª©í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        <option v-for="g in goalList" :key="g.code" :value="g.code">
          {{ g.label }}
        </option>
      </select>
      <p v-if="errors.goal" class="error-message">ìš´ë™ ëª©í‘œëŠ” í•„ìˆ˜ ì„ íƒ í•­ëª©ì…ë‹ˆë‹¤.</p>
    </div>

    <!-- ë‹´ë‹¹ íŠ¸ë ˆì´ë„ˆ -->
    <div class="form-group">
      <label class="form-label">
        <span class="label-icon">ğŸ‘¨â€ğŸ’¼</span>
        ë‹´ë‹¹ íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ (ì„ íƒì‚¬í•­)
      </label>
      <div class="flex gap-2">
        <input
          v-model="model.trainerNickname"
          type="text"
          class="form-input flex-1"
          :class="{ 'error': errors.trainerNickname }"
          placeholder="íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”"
          @input="handleTrainerNicknameChange"
        />
        <button 
          @click="checkTrainer" 
          class="trainer-check-btn"
          :disabled="!model.trainerNickname"
        >
          í™•ì¸
        </button>
      </div>
      
      <div v-if="model.trainerNickname" class="mt-2">
        <p v-if="memberTrainerExists === true" class="success-message">
          âœ… íŠ¸ë ˆì´ë„ˆê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
        </p>
        <p v-else-if="memberTrainerExists === false" class="error-message">
          âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤.
        </p>
        <p v-else-if="memberTrainerExists === null && !trainerCheckRequested" class="warning-message">
          âš ï¸ íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </p>
      </div>
      <p v-if="errors.trainerNickname" class="error-message">
        íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•œ ê²½ìš° ë°˜ë“œì‹œ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ê²€ì¦í•´ì£¼ì„¸ìš”.
      </p>
    </div>

    <!-- ì•Œë ˆë¥´ê¸° ì„¹ì…˜ -->
    <div class="section-divider">
      <h4 class="subsection-title">
        <span class="subsection-icon">ğŸŒ°</span>
        ì•Œë ˆë¥´ê¸° ì •ë³´
      </h4>
    </div>

    <!-- ì•Œë ˆë¥´ê¸° ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
    <div class="form-group">
      <label class="form-label">
        <span class="label-icon">ğŸ“‚</span>
        ì•Œë ˆë¥´ê¸° ì¹´í…Œê³ ë¦¬
      </label>
      <select v-model="selectedCategory" class="form-input">
        <option disabled value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        <option v-for="(list, category) in allergyMap" :key="category" :value="category">
          {{ category }}
        </option>
      </select>
    </div>

    <!-- ì•Œë ˆë¥´ê¸° ì²´í¬ë°•ìŠ¤ ëª©ë¡ -->
    <div v-if="selectedCategory" class="form-group">
      <label class="form-label">
        <span class="label-icon">âœ…</span>
        {{ selectedCategory }} ì•Œë ˆë¥´ê¸° ì„ íƒ
      </label>
      <div class="checkbox-grid">
        <label 
          v-for="a in allergyMap[selectedCategory]" 
          :key="a.allergyId" 
          class="checkbox-item"
        >
          <input
            type="checkbox"
            :value="a.allergyId"
            v-model="model.allergyIds"
            class="checkbox-input"
          />
          <span class="checkbox-label">{{ a.name }}</span>
        </label>
      </div>
    </div>

    <!-- ì„ íƒëœ ì•Œë ˆë¥´ê¸° í‘œì‹œ -->
    <div v-if="selectedAllergyNames.length > 0" class="form-group">
      <label class="form-label">
        <span class="label-icon">ğŸ·ï¸</span>
        ì„ íƒëœ ì•Œë ˆë¥´ê¸°
      </label>
      <div class="allergy-tags">
        <span
          v-for="(name, index) in selectedAllergyNames"
          :key="index"
          class="allergy-tag"
        >
          {{ name }}
        </span>
      </div>
    </div>
  </div>
</template>

<script setup>
import { onMounted, ref, computed, watch } from 'vue'
const model = defineModel()
const emit = defineEmits(['validation-change'])

const trainerExists = ref(null)

// ìœ íš¨ì„± ê²€ì‚¬ ì—ëŸ¬ ìƒíƒœ
const errors = ref({
  height: false,
  weight: false,
  goal: false,
  trainerNickname: false
})

// íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ê´€ë ¨ ìƒíƒœ
const memberTrainerExists = ref(null)
const trainerCheckRequested = ref(false) // í™•ì¸ ë²„íŠ¼ì„ ëˆŒë €ëŠ”ì§€ ì—¬ë¶€

// íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ê²€ì¦ í•¨ìˆ˜
const isTrainerNicknameValid = computed(() => {
  // íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš°: ìœ íš¨ (ì„ íƒì‚¬í•­ì´ë¯€ë¡œ)
  if (!model.value.trainerNickname || model.value.trainerNickname.trim() === '') {
    return true
  }
  
  // íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•œ ê²½ìš°: í™•ì¸ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ì¡´ì¬í•˜ëŠ” íŠ¸ë ˆì´ë„ˆì—¬ì•¼ í•¨
  return trainerCheckRequested.value && memberTrainerExists.value === true
})

// í¼ ìœ íš¨ì„± ê²€ì‚¬
const isFormValid = computed(() => {
  return model.value.height && 
         model.value.weight && 
         model.value.goal &&
         model.value.height > 0 &&
         model.value.weight > 0 &&
         isTrainerNicknameValid.value // íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ê²€ì¦ ì¶”ê°€
})

// í•„ìˆ˜ í•­ëª© ê²€ì¦ í•¨ìˆ˜
const validateForm = () => {
  errors.value.height = !model.value.height || model.value.height <= 0
  errors.value.weight = !model.value.weight || model.value.weight <= 0
  errors.value.goal = !model.value.goal
  
  // íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ê²€ì¦
  if (model.value.trainerNickname && model.value.trainerNickname.trim() !== '') {
    errors.value.trainerNickname = !isTrainerNicknameValid.value
  } else {
    errors.value.trainerNickname = false
  }
  
  return isFormValid.value
}

// íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ì…ë ¥ê°’ ë³€ê²½ ì‹œ í˜¸ì¶œ
const handleTrainerNicknameChange = () => {
  // ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ë©´ ì´ì „ ê²€ì¦ ê²°ê³¼ ì´ˆê¸°í™”
  memberTrainerExists.value = null
  trainerCheckRequested.value = false
  
  // ì‹¤ì‹œê°„ ê²€ì¦
  validateForm()
}

// ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸ì— ìœ íš¨ì„± ìƒíƒœ ì „ë‹¬
watch(isFormValid, (valid) => {
  emit('validation-change', valid)
}, { immediate: true })

// ëª¨ë¸ ê°’ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ê²€ì¦
watch(() => [model.value.height, model.value.weight, model.value.goal], () => {
  validateForm()
}, { deep: true })

// íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ ìœ íš¨ì„± ë³€ê²½ ì‹œ ê²€ì¦
watch(isTrainerNicknameValid, () => {
  validateForm()
})

// ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ê²€ì¦ í•¨ìˆ˜ ë…¸ì¶œ
defineExpose({
  validateForm,
  isFormValid
})

const checkTrainer = async () => {
  if (!model.value.trainerNickname) {
    memberTrainerExists.value = null
    trainerCheckRequested.value = false
    return
  }

  try {
    trainerCheckRequested.value = true // í™•ì¸ ë²„íŠ¼ì„ ëˆŒë €ìŒì„ í‘œì‹œ
    const res = await fetch(`/api/users/check-trainer-nickname?nickname=${encodeURIComponent(model.value.trainerNickname)}`)
    const data = await res.json()
    memberTrainerExists.value = data.data
    
    // ê²€ì¦ í›„ í¼ ìœ íš¨ì„± ì¬ê²€ì‚¬
    validateForm()
  } catch (e) {
    console.error('íŠ¸ë ˆì´ë„ˆ ë‹‰ë„¤ì„ í™•ì¸ ì‹¤íŒ¨:', e)
    memberTrainerExists.value = false
    validateForm()
  }
}

// ì•Œë ˆë¥´ê¸° ê´€ë ¨
const allergyMap = ref({})
const selectedCategory = ref('')

// ëª©í‘œ ê´€ë ¨
const goalList = ref([])

// ì„ íƒëœ ì•Œë ˆë¥´ê¸° ì´ë¦„ ë¦¬ìŠ¤íŠ¸
const selectedAllergyNames = computed(() => {
  const result = []
  for (const category in allergyMap.value) {
    for (const a of allergyMap.value[category]) {
      if (model.value.allergyIds?.includes(a.allergyId)) {
        result.push(a.name)
      }
    }
  }
  return result
})

// API í˜¸ì¶œ
const loadAllergies = async () => {
  try {
    const res = await fetch('/api/allergies/grouped')
    const data = await res.json()
    allergyMap.value = data.data
  } catch (e) {
    console.error('ì•Œë ˆë¥´ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', e)
  }
}

const loadGoals = async () => {
  try {
    const res = await fetch('/api/common/goal')
    const data = await res.json()
    goalList.value = data.data
  } catch (e) {
    console.error('ëª©í‘œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', e)
  }
}

onMounted(() => {
  model.value.allergyIds = model.value.allergyIds || []
  loadAllergies()
  loadGoals()
})
</script>

<style scoped>
/* í•„ìˆ˜ í•­ëª© ì•ˆë‚´ */
.required-notice {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 1.25rem;
  background: linear-gradient(135deg, #fef3c7, #fed7aa);
  border: 1px solid #f59e0b;
  border-radius: 12px;
  margin-bottom: 1.5rem;
}

.notice-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.notice-text {
  color: #92400e;
  font-size: 0.9rem;
}

.notice-text strong {
  color: #78350f;
}

.notice-items {
  font-size: 0.8rem;
  color: #a16207;
  margin-top: 0.25rem;
}

/* ì„¹ì…˜ í—¤ë” */
.section-header {
  text-align: center;
  margin-bottom: 2rem;
}

.section-title {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  font-size: 1.5rem;
  font-weight: 700;
  color: #374151;
  margin-bottom: 0.5rem;
}

.section-icon {
  font-size: 1.75rem;
}

.section-subtitle {
  color: #6b7280;
  font-size: 0.95rem;
}

/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-divider {
  margin: 2rem 0 1.5rem 0;
  padding-top: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.subsection-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1.2rem;
  font-weight: 600;
  color: #4b5563;
  margin-bottom: 1rem;
}

.subsection-icon {
  font-size: 1.25rem;
}

/* í¼ ê·¸ë£¹ */
.form-group {
  animation: slideInUp 0.4s ease-out;
}

.form-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.75rem;
}

.form-label.required::after {
  content: "*";
  color: #ef4444;
  margin-left: 0.25rem;
}

.label-icon {
  font-size: 1.1rem;
}

.form-input {
  width: 100%;
  padding: 0.875rem 1rem;
  background-color: rgba(255, 255, 255, 0.9);
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  outline: none;
}

.form-input:focus {
  border-color: #f59e0b;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
  background-color: #ffffff;
}

.form-input.error {
  border-color: #ef4444;
  background-color: rgba(254, 242, 242, 0.9);
}

.form-input.error:focus {
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-input::placeholder {
  color: #9ca3af;
}

/* íŠ¸ë ˆì´ë„ˆ í™•ì¸ ë²„íŠ¼ */
.trainer-check-btn {
  padding: 0.875rem 1rem;
  background-color: #3b82f6;
  border: 2px solid #3b82f6;
  color: white;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
  min-width: 70px;
}

.trainer-check-btn:hover:not(:disabled) {
  background-color: #2563eb;
  border-color: #2563eb;
  transform: translateY(-1px);
}

.trainer-check-btn:disabled {
  background-color: #9ca3af;
  border-color: #9ca3af;
  cursor: not-allowed;
}

/* ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ë“œ */
.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background-color: rgba(255, 255, 255, 0.8);
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.checkbox-item:hover {
  background-color: rgba(245, 158, 11, 0.05);
  border-color: rgba(245, 158, 11, 0.3);
}

.checkbox-input {
  width: 1.2rem;
  height: 1.2rem;
  accent-color: #f59e0b;
}

.checkbox-label {
  font-size: 0.9rem;
  color: #374151;
  cursor: pointer;
}

/* ì•Œë ˆë¥´ê¸° íƒœê·¸ */
.allergy-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.allergy-tag {
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
  transition: all 0.3s ease;
}

.allergy-tag:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
}

/* ë©”ì‹œì§€ */
.error-message {
  color: #dc2626;
  font-size: 0.85rem;
  margin-top: 0.5rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.error-message::before {
  content: "âš ï¸";
  font-size: 0.75rem;
}

.success-message {
  color: #059669;
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.warning-message {
  color: #d97706;
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

/* ì• ë‹ˆë©”ì´ì…˜ */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .checkbox-grid {
    grid-template-columns: 1fr;
  }
  
  .form-input {
    font-size: 16px; /* iOS zoom ë°©ì§€ */
  }
  
  .section-title {
    font-size: 1.3rem;
  }
  
  .subsection-title {
    font-size: 1.1rem;
  }
}
</style>